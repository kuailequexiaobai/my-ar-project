<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAR 粒子互动系统</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <style>
        body{margin:0;overflow:hidden;background:black;color:white;font-family:sans-serif;}
        #startBtn{
            position: fixed;
            top:0;left:0;width:100vw;height:100vh;
            background:black;
            display:flex;
            justify-content:center;
            align-items:center;
            color:white;
            font-size:28px;
            z-index:9999;
        }
        #output_video{display:none;}
        #three-container{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:2;}
        #video-container{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:1;}
    </style>
</head>
<body>

    <!-- iOS 必须点击一次 -->
    <div id="startBtn">点击开始 AR</div>

    <div id="video-container">
        <video id="output_video" playsinline autoplay muted></video>
    </div>
    <div id="three-container"></div>

    <script>
        let scene, camera, renderer;
        let hands, videoElement;

        // ============ Three 初始化 ============
        function initThree(){
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight,0.1,2000);
            camera.position.z = 300;

            renderer = new THREE.WebGLRenderer({alpha:true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById("three-container").appendChild(renderer.domElement);

            animate();
        }

        function animate(){
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        // ============ MediaPipe 初始化 ============
        function initMediaPipe(){
            videoElement = document.getElementById("output_video");

            hands = new Hands({
                locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
            });
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1
            });

            const cam = new Camera(videoElement, {
                width:1280, height:720,
                onFrame:async()=>{
                    await hands.send({image:videoElement});
                }
            });
            cam.start();
        }

        // ============ iPad 必须点击启动摄像头 ============
        document.getElementById("startBtn").onclick = async function(){
            this.style.display = "none";

            try{
                await document.getElementById("output_video").play();
            }catch(e){
                console.log("iOS autoplay blocked:", e);
            }

            initThree();
            initMediaPipe();
        };
    </script>
</body>
</html>